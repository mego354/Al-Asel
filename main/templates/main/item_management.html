{% extends "main/layout.html" %}
{% load static %}

{% block body %}
<!-- Breadcrumb -->
<nav class="flex mb-6" aria-label="Breadcrumb">
  <ol class="inline-flex items-center space-x-1 space-x-reverse md:space-x-2 md:space-x-reverse">
    <li class="inline-flex items-center">
      <a href="{% url 'main:category_management' %}" class="text-sm font-medium text-gray-700 hover:text-primary">إدارة الأنواع</a>
    </li>
    <li>
      <div class="flex items-center">
        <i class="fa-solid fa-chevron-left text-gray-400 mx-1"></i>
        <span class="ml-1 text-sm font-medium text-primary md:ml-2">إدارة المنتجات</span>
      </div>
    </li>
  </ol>
</nav>

<!-- Header -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
  <div class="p-6 text-center">
    <h1 class="text-3xl font-bold text-primary flex items-center justify-center">
      <i class="fa-solid fa-box ml-2"></i>
      إدارة المنتجات
    </h1>
    <p class="text-gray-600 mt-2">إضافة وتعديل وحذف المنتجات</p>
  </div>
</div>

<!-- Add Item Form -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
  <div class="p-6 border-b border-gray-200">
    <h2 class="text-xl font-semibold text-gray-900 flex items-center">
      <i class="fa-solid fa-plus-circle text-primary ml-2"></i>
      إضافة منتج جديد
    </h2>
  </div>
  <div class="p-6">
    <form method="post" class="max-w-2xl">
      {% csrf_token %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <div>
          <label for="{{ form.category.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">النوع</label>
          {{ form.category }}
          {% if form.category.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.category.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">اسم المنتج</label>
          {{ form.name }}
          {% if form.name.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.name.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label for="{{ form.real_price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">السعر الحقيقي</label>
          {{ form.real_price }}
          {% if form.real_price.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.real_price.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label for="{{ form.gomla_price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">سعر الجملة</label>
          {{ form.gomla_price }}
          {% if form.gomla_price.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.gomla_price.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label for="{{ form.market_price.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">سعر السوق</label>
          {{ form.market_price }}
          {% if form.market_price.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.market_price.errors.0 }}</p>
          {% endif %}
        </div>
        <div>
          <label for="{{ form.stock_quantity.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">كمية المخزون</label>
          {{ form.stock_quantity }}
          {% if form.stock_quantity.errors %}
            <p class="text-red-600 text-sm mt-1">{{ form.stock_quantity.errors.0 }}</p>
          {% endif %}
        </div>
      </div>
      <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors mt-6">
        <i class="fa-solid fa-plus ml-2"></i>
        إضافة المنتج
      </button>
    </form>
  </div>
</div>

<!-- Items List -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200">
  <div class="p-6 border-b border-gray-200">
    <h2 class="text-xl font-semibold text-gray-900 flex items-center">
      <i class="fa-solid fa-list text-primary ml-2"></i>
      المنتجات الموجودة
    </h2>
  </div>
  <div class="p-6">
    {% if item_stats %}
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
            <tr>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المنتج</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">النوع</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الأسعار</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">المخزون</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإحصائيات</th>
              <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">الإجراءات</th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for stat in item_stats %}
            <tr class="hover:bg-gray-50">
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm font-medium text-gray-900">{{ stat.item.name }}</div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  {{ stat.item.category.name }}
                </span>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <div class="space-y-1">
                  <div>حقيقي: <span class="font-semibold">{{ stat.item.real_price }}</span> ج.م</div>
                  <div>جملة: <span class="font-semibold">{{ stat.item.gomla_price }}</span> ج.م</div>
                  <div>سوق: <span class="font-semibold">{{ stat.item.market_price }}</span> ج.م</div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap">
                <div class="text-sm text-gray-900">
                  <div>المخزون: <span class="font-semibold">{{ stat.item.stock_quantity }}</span></div>
                  <div>المستخدم: <span class="font-semibold text-orange-600">{{ stat.item.used_quantity }}</span></div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">
                <div class="space-y-1">
                  <div>الطلبات: <span class="font-semibold text-blue-600">{{ stat.total_orders }}</span></div>
                  <div>الكمية المباعة: <span class="font-semibold text-green-600">{{ stat.total_quantity_sold }}</span></div>
                </div>
              </td>
              <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                <div class="flex space-x-2 space-x-reverse">
                  <button 
                    onclick="editItem({{ stat.item.id }}, '{{ stat.item.name }}', {{ stat.item.category.id }}, {{ stat.item.real_price }}, {{ stat.item.gomla_price }}, {{ stat.item.market_price }}, {{ stat.item.stock_quantity }})"
                    class="text-blue-600 hover:text-blue-900 p-2 hover:bg-blue-100 rounded-lg transition-colors"
                    title="تعديل"
                  >
                    <i class="fa-solid fa-edit"></i>
                  </button>
                  {% if stat.can_delete %}
                    <button 
                      onclick="deleteItem({{ stat.item.id }}, '{{ stat.item.name }}')"
                      class="text-red-600 hover:text-red-900 p-2 hover:bg-red-100 rounded-lg transition-colors"
                      title="حذف"
                    >
                      <i class="fa-solid fa-trash"></i>
                    </button>
                  {% else %}
                    <button 
                      disabled
                      class="text-gray-400 cursor-not-allowed p-2"
                      title="لا يمكن الحذف - مستخدم في طلبات"
                    >
                      <i class="fa-solid fa-lock"></i>
                    </button>
                  {% endif %}
                </div>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="text-center py-12">
        <i class="fa-solid fa-box text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-500 mb-2">لا توجد منتجات</h3>
        <p class="text-gray-400">ابدأ بإضافة منتج جديد أعلاه</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Edit Item Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full">
      <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">تعديل المنتج</h3>
      </div>
      <form id="editForm" class="p-6">
        {% csrf_token %}
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div>
            <label for="editCategory" class="block text-sm font-medium text-gray-700 mb-2">النوع</label>
            <select 
              id="editCategory" 
              name="category" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              required
            >
              {% for category in categories %}
                <option value="{{ category.id }}">{{ category.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div>
            <label for="editName" class="block text-sm font-medium text-gray-700 mb-2">اسم المنتج</label>
            <input 
              type="text" 
              id="editName" 
              name="name" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              required
            >
          </div>
          <div>
            <label for="editRealPrice" class="block text-sm font-medium text-gray-700 mb-2">السعر الحقيقي</label>
            <input 
              type="number" 
              id="editRealPrice" 
              name="real_price" 
              step="0.01" 
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              required
            >
          </div>
          <div>
            <label for="editGomlaPrice" class="block text-sm font-medium text-gray-700 mb-2">سعر الجملة</label>
            <input 
              type="number" 
              id="editGomlaPrice" 
              name="gomla_price" 
              step="0.01" 
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              required
            >
          </div>
          <div>
            <label for="editMarketPrice" class="block text-sm font-medium text-gray-700 mb-2">سعر السوق</label>
            <input 
              type="number" 
              id="editMarketPrice" 
              name="market_price" 
              step="0.01" 
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              required
            >
          </div>
          <div>
            <label for="editStockQuantity" class="block text-sm font-medium text-gray-700 mb-2">كمية المخزون</label>
            <input 
              type="number" 
              id="editStockQuantity" 
              name="stock_quantity" 
              min="0"
              class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
              required
            >
          </div>
        </div>
        <div class="flex space-x-3 space-x-reverse mt-6">
          <button 
            type="button" 
            onclick="closeEditModal()" 
            class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors"
          >
            إلغاء
          </button>
          <button 
            type="submit" 
            class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors"
          >
            حفظ التعديل
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Alert Container -->
<div id="alertContainer" class="fixed top-4 right-4 z-50 space-y-2 space-y-reverse"></div>

<script>
let currentItemId = null;

function editItem(id, name, categoryId, realPrice, gomlaPrice, marketPrice, stockQuantity) {
  currentItemId = id;
  document.getElementById('editName').value = name;
  document.getElementById('editCategory').value = categoryId;
  document.getElementById('editRealPrice').value = realPrice;
  document.getElementById('editGomlaPrice').value = gomlaPrice;
  document.getElementById('editMarketPrice').value = marketPrice;
  document.getElementById('editStockQuantity').value = stockQuantity;
  document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
  currentItemId = null;
}

function deleteItem(id, name) {
  if (confirm(`هل أنت متأكد من حذف المنتج "${name}"؟`)) {
    fetch(`/manage/items/${id}/delete`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      showAlert(data.message, data.success ? 'success' : 'error');
      if (data.success) {
        setTimeout(() => location.reload(), 1500);
      }
    })
    .catch(error => {
      showAlert('حدث خطأ في الاتصال', 'error');
    });
  }
}

document.getElementById('editForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  
  fetch(`/manage/items/${currentItemId}/update`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    showAlert(data.message, data.success ? 'success' : 'error');
    if (data.success) {
      closeEditModal();
      setTimeout(() => location.reload(), 1500);
    }
  })
  .catch(error => {
    showAlert('حدث خطأ في الاتصال', 'error');
  });
});

function showAlert(message, type) {
  const alertContainer = document.getElementById('alertContainer');
  const alert = document.createElement('div');
  
  const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
  const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
  
  alert.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 space-x-reverse max-w-sm`;
  alert.innerHTML = `
    <i class="fa-solid ${icon}"></i>
    <span>${message}</span>
  `;
  
  alertContainer.appendChild(alert);
  
  setTimeout(() => {
    alert.remove();
  }, 5000);
}

// Close modal when clicking outside
document.getElementById('editModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeEditModal();
  }
});
</script>
{% endblock %}
