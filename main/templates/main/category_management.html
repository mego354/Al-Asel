{% extends "main/layout.html" %}
{% load static %}

{% block body %}
<!-- Breadcrumb -->
<nav class="flex mb-6" aria-label="Breadcrumb">
  <ol class="inline-flex items-center space-x-1 space-x-reverse md:space-x-2 md:space-x-reverse">
    <li class="inline-flex items-center">
      <a href="{% url 'main:item_management' %}" class="text-sm font-medium text-gray-700 hover:text-primary">إدارة المنتجات</a>
    </li>
    <li>
      <div class="flex items-center">
        <i class="fa-solid fa-chevron-left text-gray-400 mx-1"></i>
        <span class="ml-1 text-sm font-medium text-primary md:ml-2">إدارة الأنواع</span>
      </div>
    </li>
  </ol>
</nav>

<!-- Header -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
  <div class="p-6 text-center">
    <h1 class="text-3xl font-bold text-primary flex items-center justify-center">
      <i class="fa-solid fa-tags ml-2"></i>
      إدارة الأنواع
    </h1>
    <p class="text-gray-600 mt-2">إضافة وتعديل وحذف أنواع المنتجات</p>
  </div>
</div>

<!-- Add Category Form -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
  <div class="p-6 border-b border-gray-200">
    <h2 class="text-xl font-semibold text-gray-900 flex items-center">
      <i class="fa-solid fa-plus-circle text-primary ml-2"></i>
      إضافة نوع جديد
    </h2>
  </div>
  <div class="p-6">
    <form method="post" class="max-w-md">
      {% csrf_token %}
      <div class="mb-4">
        <label for="{{ form.name.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">اسم النوع</label>
        {{ form.name }}
        {% if form.name.errors %}
          <p class="text-red-600 text-sm mt-1">{{ form.name.errors.0 }}</p>
        {% endif %}
      </div>
      <button type="submit" class="w-full bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors">
        <i class="fa-solid fa-plus ml-2"></i>
        إضافة النوع
      </button>
    </form>
  </div>
</div>

<!-- Categories List -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200">
  <div class="p-6 border-b border-gray-200">
    <h2 class="text-xl font-semibold text-gray-900 flex items-center">
      <i class="fa-solid fa-list text-primary ml-2"></i>
      الأنواع الموجودة
    </h2>
  </div>
  <div class="p-6">
    {% if category_stats %}
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
        {% for stat in category_stats %}
        <div class="bg-gray-50 rounded-lg p-6 border border-gray-200 hover:border-primary/30 transition-colors">
          <div class="flex items-center justify-between mb-4">
            <h3 class="text-lg font-semibold text-gray-900">{{ stat.category.name }}</h3>
            <div class="flex space-x-2 space-x-reverse">
              <button 
                onclick="editCategory({{ stat.category.id }}, '{{ stat.category.name }}')"
                class="p-2 text-blue-600 hover:bg-blue-100 rounded-lg transition-colors"
                title="تعديل"
              >
                <i class="fa-solid fa-edit"></i>
              </button>
              {% if stat.can_delete %}
                <button 
                  onclick="deleteCategory({{ stat.category.id }}, '{{ stat.category.name }}')"
                  class="p-2 text-red-600 hover:bg-red-100 rounded-lg transition-colors"
                  title="حذف"
                >
                  <i class="fa-solid fa-trash"></i>
                </button>
              {% else %}
                <button 
                  disabled
                  class="p-2 text-gray-400 cursor-not-allowed"
                  title="لا يمكن الحذف - يحتوي على منتجات"
                >
                  <i class="fa-solid fa-lock"></i>
                </button>
              {% endif %}
            </div>
          </div>
          
          <div class="space-y-3">
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">عدد المنتجات:</span>
              <span class="font-semibold text-gray-900">{{ stat.items_count }}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">المنتجات المستخدمة:</span>
              <span class="font-semibold text-green-600">{{ stat.used_items_count }}</span>
            </div>
            <div class="flex items-center justify-between">
              <span class="text-sm text-gray-600">إجمالي الطلبات:</span>
              <span class="font-semibold text-blue-600">{{ stat.total_orders }}</span>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>
    {% else %}
      <div class="text-center py-12">
        <i class="fa-solid fa-tags text-6xl text-gray-300 mb-4"></i>
        <h3 class="text-xl font-semibold text-gray-500 mb-2">لا توجد أنواع</h3>
        <p class="text-gray-400">ابدأ بإضافة نوع جديد أعلاه</p>
      </div>
    {% endif %}
  </div>
</div>

<!-- Edit Category Modal -->
<div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden">
  <div class="flex items-center justify-center min-h-screen p-4">
    <div class="bg-white rounded-lg shadow-xl max-w-md w-full">
      <div class="p-6 border-b border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900">تعديل النوع</h3>
      </div>
      <form id="editForm" class="p-6">
        {% csrf_token %}
        <div class="mb-4">
          <label for="editName" class="block text-sm font-medium text-gray-700 mb-2">اسم النوع</label>
          <input 
            type="text" 
            id="editName" 
            name="name" 
            class="w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
            required
          >
        </div>
        <div class="flex space-x-3 space-x-reverse">
          <button 
            type="button" 
            onclick="closeEditModal()" 
            class="flex-1 bg-gray-300 text-gray-700 py-2 px-4 rounded-lg hover:bg-gray-400 transition-colors"
          >
            إلغاء
          </button>
          <button 
            type="submit" 
            class="flex-1 bg-primary text-white py-2 px-4 rounded-lg hover:bg-primary/90 transition-colors"
          >
            حفظ التعديل
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Alert Container -->
<div id="alertContainer" class="fixed top-4 right-4 z-50 space-y-2 space-y-reverse"></div>

<script>
let currentCategoryId = null;

function editCategory(id, name) {
  currentCategoryId = id;
  document.getElementById('editName').value = name;
  document.getElementById('editModal').classList.remove('hidden');
}

function closeEditModal() {
  document.getElementById('editModal').classList.add('hidden');
  currentCategoryId = null;
}

function deleteCategory(id, name) {
  if (confirm(`هل أنت متأكد من حذف النوع "${name}"؟`)) {
    fetch(`/manage/categories/${id}/delete`, {
      method: 'POST',
      headers: {
        'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
        'Content-Type': 'application/json',
      },
    })
    .then(response => response.json())
    .then(data => {
      showAlert(data.message, data.success ? 'success' : 'error');
      if (data.success) {
        setTimeout(() => location.reload(), 1500);
      }
    })
    .catch(error => {
      showAlert('حدث خطأ في الاتصال', 'error');
    });
  }
}

document.getElementById('editForm').addEventListener('submit', function(e) {
  e.preventDefault();
  
  const formData = new FormData(this);
  formData.append('name', document.getElementById('editName').value);
  
  fetch(`/manage/categories/${currentCategoryId}/update`, {
    method: 'POST',
    headers: {
      'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
    },
    body: formData
  })
  .then(response => response.json())
  .then(data => {
    showAlert(data.message, data.success ? 'success' : 'error');
    if (data.success) {
      closeEditModal();
      setTimeout(() => location.reload(), 1500);
    }
  })
  .catch(error => {
    showAlert('حدث خطأ في الاتصال', 'error');
  });
});

function showAlert(message, type) {
  const alertContainer = document.getElementById('alertContainer');
  const alert = document.createElement('div');
  
  const bgColor = type === 'success' ? 'bg-green-500' : 'bg-red-500';
  const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
  
  alert.className = `${bgColor} text-white px-6 py-3 rounded-lg shadow-lg flex items-center space-x-2 space-x-reverse max-w-sm`;
  alert.innerHTML = `
    <i class="fa-solid ${icon}"></i>
    <span>${message}</span>
  `;
  
  alertContainer.appendChild(alert);
  
  setTimeout(() => {
    alert.remove();
  }, 5000);
}

// Close modal when clicking outside
document.getElementById('editModal').addEventListener('click', function(e) {
  if (e.target === this) {
    closeEditModal();
  }
});
</script>
{% endblock %}
