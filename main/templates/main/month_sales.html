{% extends "main/layout.html" %}
{% load static %}

{% block body %}
<!-- Breadcrumb -->
<nav class="flex mb-6" aria-label="Breadcrumb">
  <ol class="inline-flex items-center space-x-1 space-x-reverse md:space-x-2 md:space-x-reverse">
    <li class="inline-flex items-center">
      <a href="{% url 'main:total_orders' %}" class="text-sm font-medium text-gray-700 hover:text-primary">المبيعات</a>
    </li>
    <li>
      <div class="flex items-center">
        <i class="fa-solid fa-chevron-left text-gray-400 mx-1"></i>
        <span class="ml-1 text-sm font-medium text-primary md:ml-2">{{ year }}</span>
      </div>
    </li>
    <li>
      <div class="flex items-center">
        <i class="fa-solid fa-chevron-left text-gray-400 mx-1"></i>
        <span class="ml-1 text-sm font-medium text-primary md:ml-2">{{ shahr }}</span>
      </div>
    </li>
  </ol>
</nav>

<!-- Header -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
  <div class="p-6 text-center">
    <h1 class="text-3xl font-bold text-primary flex items-center justify-center">
      <i class="fa-solid fa-chart-line ml-2"></i>
      خلال شهر {{ shahr }} {{ year }}
    </h1>
  </div>
</div>

<!-- Charts and Statistics -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
  <!-- Monthly Chart -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-4">توزيع المبيعات</h3>
      <div class="h-80">
        <canvas id="month_chart"></canvas>
      </div>
    </div>
  </div>

  <!-- Monthly Statistics -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="p-6">
      <h3 class="text-lg font-semibold text-gray-900 mb-6">إحصائيات الشهر</h3>
      <div class="space-y-4">
        <div class="flex items-center justify-between p-4 bg-blue-50 rounded-lg">
          <div>
            <h4 class="text-sm font-medium text-blue-900">عدد الطلبات</h4>
            <p class="text-2xl font-bold text-blue-600">{{ month_data.order_count }}</p>
          </div>
          <i class="fa-solid fa-shopping-cart text-blue-500 text-2xl"></i>
        </div>

        <div class="flex items-center justify-between p-4 bg-green-50 rounded-lg">
          <div>
            <h4 class="text-sm font-medium text-green-900">إجمالي مبيعات</h4>
            <p class="text-2xl font-bold text-green-600 money">{{ month_data.orders_sales }}</p>
          </div>
          <i class="fa-solid fa-chart-line text-green-500 text-2xl"></i>
        </div>

        <div class="flex items-center justify-between p-4 bg-purple-50 rounded-lg">
          <div>
            <h4 class="text-sm font-medium text-purple-900">متوسط سعر الطلب</h4>
            <p class="text-2xl font-bold text-purple-600 money">{{ month_data.average_order }}</p>
          </div>
          <i class="fa-solid fa-calculator text-purple-500 text-2xl"></i>
        </div>

        <div class="flex items-center justify-between p-4 bg-red-50 rounded-lg">
          <div>
            <h4 class="text-sm font-medium text-red-900">الآجل من المبيعات</h4>
            <p class="text-2xl font-bold text-red-600 money">{{ month_data.debt }}</p>
          </div>
          <i class="fa-solid fa-clock text-red-500 text-2xl"></i>
        </div>

        <div class="flex items-center justify-between p-4 bg-yellow-50 rounded-lg">
          <div>
            <h4 class="text-sm font-medium text-yellow-900">الربح من المبيعات</h4>
            <p class="text-2xl font-bold text-yellow-600 money">{{ month_data.profit }}</p>
          </div>
          <i class="fa-solid fa-coins text-yellow-500 text-2xl"></i>
        </div>

        <div class="flex items-center justify-between p-4 bg-indigo-50 rounded-lg">
          <div>
            <h4 class="text-sm font-medium text-indigo-900">سعر الطلبيات</h4>
            <p class="text-2xl font-bold text-indigo-600 money">{{ month_data.coming_sales }}</p>
          </div>
          <i class="fa-solid fa-truck text-indigo-500 text-2xl"></i>
        </div>

        <div class="flex items-center justify-between p-4 bg-orange-50 rounded-lg">
          <div>
            <h4 class="text-sm font-medium text-orange-900">آجل للطلبيات</h4>
            <p class="text-2xl font-bold text-orange-600 money">{{ month_data.coming_debt }}</p>
          </div>
          <i class="fa-solid fa-exclamation-triangle text-orange-500 text-2xl"></i>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Debt Chart -->
<div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-8">
  <div class="p-6">
    <h3 class="text-lg font-semibold text-gray-900 mb-4 text-center">توزيع الديون والأرباح</h3>
    <div class="h-96 flex items-center justify-center">
      <canvas id="debt_chart" class="max-w-md"></canvas>
    </div>
  </div>
</div>

<!-- Orders Lists -->
<div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
  <!-- Sales Orders -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900 flex items-center">
        <i class="fa-solid fa-shopping-cart text-primary ml-2"></i>
        جميع الطلبات خلال الشهر
      </h2>
    </div>
    <div class="p-6">
      <div class="space-y-3 max-h-96 overflow-y-auto">
        {% for order in month_data.orders %}
        <a 
          href="{% url 'main:order_info' order.id %}" 
          class="block p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors border border-gray-200 hover:border-primary/30"
        >
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-2 space-x-reverse">
                <span class="font-semibold text-gray-900">#{{ order.id }}</span>
                <span class="text-gray-600">
                  {% if not order.customer.is_shop %}
                    للعميل {{ order.customer.name }}
                  {% else %}
                    إلى فرع {{ order.customer.name }}
                  {% endif %}
                </span>
              </div>
              <div class="text-sm text-gray-500 mt-1">
                <i class="fa-solid fa-calendar ml-1"></i>
                {{ order.created_at|date:"d/m/Y" }}
              </div>
            </div>
            <div class="flex items-center">
              {% if order.is_fully_paid %}
                <i class="fa-solid fa-check-circle text-green-500 text-xl" title="مدفوع بالكامل"></i>
              {% else %}
                <i class="fa-solid fa-clock text-yellow-500 text-xl" title="غير مدفوع بالكامل"></i>
              {% endif %}
            </div>
          </div>
        </a>
        {% empty %}
        <div class="text-center py-8 text-gray-500">
          <i class="fa-solid fa-inbox text-4xl mb-4"></i>
          <p>لا توجد طلبات في هذا الشهر</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Store Orders -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="p-6 border-b border-gray-200">
      <h2 class="text-xl font-semibold text-gray-900 flex items-center">
        <i class="fa-solid fa-truck text-primary ml-2"></i>
        جميع الطلبيات خلال الشهر
      </h2>
    </div>
    <div class="p-6">
      <div class="space-y-3 max-h-96 overflow-y-auto">
        {% for order in month_data.coming_orders %}
        <a 
          href="{% url 'main:coming_order_info' order.id %}" 
          class="block p-4 bg-gray-50 hover:bg-gray-100 rounded-lg transition-colors border border-gray-200 hover:border-primary/30"
        >
          <div class="flex items-center justify-between">
            <div class="flex-1">
              <div class="flex items-center space-x-2 space-x-reverse">
                <span class="font-semibold text-gray-900">#{{ order.id }}</span>
                <span class="text-gray-600">لحساب فرع {{ order.customer.name }}</span>
              </div>
              <div class="text-sm text-gray-500 mt-1">
                <i class="fa-solid fa-calendar ml-1"></i>
                {{ order.created_at|date:"d/m/Y" }}
              </div>
            </div>
            <div class="flex items-center">
              {% if order.is_fully_paid %}
                <i class="fa-solid fa-check-circle text-green-500 text-xl" title="مدفوع بالكامل"></i>
              {% else %}
                <i class="fa-solid fa-clock text-yellow-500 text-xl" title="غير مدفوع بالكامل"></i>
              {% endif %}
            </div>
          </div>
        </a>
        {% empty %}
        <div class="text-center py-8 text-gray-500">
          <i class="fa-solid fa-truck text-4xl mb-4"></i>
          <p>لا توجد طلبيات في هذا الشهر</p>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
  // Monthly Chart
  var ctx = document.getElementById('month_chart').getContext('2d');
  var monthChart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: [{% for name, value in month_char_data.items %}"{{ name }}", {% endfor %}],
      datasets: [{
        label: 'قيمة الشهر',
        data: [{% for name, value in month_char_data.items %}{{ value }}, {% endfor %}],
        backgroundColor: [
          'rgba(59, 130, 246, 0.6)',
          'rgba(239, 68, 68, 0.6)',
          'rgba(245, 158, 11, 0.6)',
          'rgba(16, 185, 129, 0.6)',
          'rgba(139, 92, 246, 0.6)',
          'rgba(236, 72, 153, 0.6)'
        ],
        borderColor: [
          'rgba(59, 130, 246, 1)',
          'rgba(239, 68, 68, 1)',
          'rgba(245, 158, 11, 1)',
          'rgba(16, 185, 129, 1)',
          'rgba(139, 92, 246, 1)',
          'rgba(236, 72, 153, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            callback: function(value) {
              return 'EGP ' + value;
            }
          }
        }
      },
      plugins: {
        title: {
          display: true,
          text: 'توزيع المبيعات - {{ shahr }} {{ year }}',
          font: {
            size: 16,
            weight: 'bold'
          }
        },
        legend: {
          display: false
        }
      }
    }
  });

  // Debt Chart
  var ctxDebt = document.getElementById('debt_chart').getContext('2d');
  var debtChart = new Chart(ctxDebt, {
    type: 'doughnut',
    data: {
      labels: [{% for name, value in debt_char_data.items %}"{{ name }}", {% endfor %}],
      datasets: [{
        data: [{% for name, value in debt_char_data.items %}{{ value }}, {% endfor %}],
        backgroundColor: [
          'rgba(16, 185, 129, 0.8)',
          'rgba(239, 68, 68, 0.8)'
        ],
        borderColor: [
          'rgba(16, 185, 129, 1)',
          'rgba(239, 68, 68, 1)'
        ],
        borderWidth: 2
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        title: {
          display: true,
          text: 'توزيع الديون والأرباح',
          font: {
            size: 16,
            weight: 'bold'
          }
        },
        legend: {
          display: true,
          position: 'bottom',
          labels: {
            font: {
              size: 14
            }
          }
        }
      }
    }
  });

  // Format money values
  document.querySelectorAll('.money').forEach(number => {
    let money = Number(number.innerHTML);
    if ((money / Math.pow(10, 9)) >= 1) {
      money = (money / Math.pow(10, 9)).toFixed(2);
      number.innerHTML = `${money}B`;
    } else if ((money / Math.pow(10, 6)) >= 1) {
      money = (money / Math.pow(10, 6)).toFixed(2);
      number.innerHTML = `${money}M`;
    } else if ((money / Math.pow(10, 3)) >= 1) {
      money = (money / Math.pow(10, 3)).toFixed(2);
      number.innerHTML = `${money}K`;
    }
  });
});
</script>
{% endblock %}